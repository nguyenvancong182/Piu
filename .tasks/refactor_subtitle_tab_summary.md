# Phase 2: Refactor Subtitle Tab - Summary

**Ng√†y ho√†n th√†nh:** 2025-11-01  
**Status:** ‚úÖ Ho√†n th√†nh 100% + Test th√†nh c√¥ng

---

## üìä T·ªïng quan

**File:** `ui/tabs/subtitle_tab.py`  
**K·∫øt qu·∫£:** T·ª´ 798 d√≤ng ‚Üí 3,391 d√≤ng (+2,593 d√≤ng)  
**L·ªói linter:** 0 errors  
**Test:** ‚úÖ App ch·∫°y th√†nh c√¥ng, kh√¥ng c√≥ l·ªói  
**Th·ªùi gian:** ~4-6 gi·ªù (theo ∆∞·ªõc t√≠nh ban ƒë·∫ßu)

---

## ‚úÖ Chi ti·∫øt t·ª´ng b∆∞·ªõc

### B∆∞·ªõc 2.1: Di chuy·ªÉn BI·∫æN (State) ‚úÖ

**T·ªïng s·ªë:** 60+ bi·∫øn state ƒë√£ di chuy·ªÉn t·ª´ `Piu.py` sang `SubtitleTab`.

#### Categories:

1. **Model & Queue (9 bi·∫øn):**
   - `whisper_model`, `loaded_model_name`, `is_loading_model`, `is_loading_model_for_timer`
   - `file_queue`, `current_file`, `current_srt_path`, `last_loaded_script_path`
   - `allow_edit_sub`, `sub_pause_selected_media_path`
   - `is_subbing`, `is_gpt_processing_script`, `is_gemini_processing`

2. **Language & Options (7 bi·∫øn):**
   - `source_lang_var`, `merge_sub_var`, `bilingual_var`, `target_lang_var`
   - `enable_split_var`, `max_chars_var`, `max_lines_var`, `split_mode_var`
   - `sub_cps_for_timing_var`

3. **Pacing - Advanced (5 bi·∫øn):**
   - `sub_pacing_pause_medium_ms_var`, `sub_pacing_pause_period_ms_var`
   - `sub_pacing_pause_question_ms_var`, `sub_pacing_long_sentence_threshold_var`
   - `sub_pacing_fast_cps_multiplier_var`

4. **Style - Font, Color, Outline (13 bi·∫øn):**
   - `sub_style_font_name_var`, `sub_style_font_size_var`, `sub_style_font_bold_var`
   - `sub_style_text_color_rgb_str_var`, `sub_style_text_opacity_percent_var`
   - `sub_style_background_mode_var`, `sub_style_bg_color_rgb_str_var`
   - `sub_style_bg_box_actual_opacity_percent_var`
   - `sub_style_outline_enabled_var`, `sub_style_outline_size_var`
   - `sub_style_outline_color_rgb_str_var`, `sub_style_outline_opacity_percent_var`
   - `sub_style_marginv_var`

5. **FFmpeg (3 bi·∫øn):**
   - `ffmpeg_encoder_var`, `ffmpeg_preset_var`, `ffmpeg_crf_var`

6. **Block Merging (3 bi·∫øn):**
   - `enable_block_merging_var`, `merge_max_time_gap_var`, `merge_curr_max_len_normal_var`

7. **Pause for Edit (1 bi·∫øn):**
   - `pause_for_edit_var`

8. **Manual Merge (1 bi·∫øn):**
   - `manual_merge_mode_var`

9. **Options kh√°c (5 bi·∫øn):**
   - `auto_format_plain_text_to_srt_var`, `auto_add_manual_sub_task_var`
   - `save_in_media_folder_var`, `optimize_whisper_tts_voice_var`
   - `is_actively_paused_for_edit`, `HAS_UNDERTHESEA_LIB`

10. **Output & Model (3 bi·∫øn):**
    - `output_path_var`, `model_var`, `format_var`

11. **GPT/Gemini Undo & Rewrite (4 bi·∫øn):**
    - `gemini_undo_buffer`, `last_gemini_parameters_used`
    - `gpt_undo_buffer`, `last_gpt_parameters_used`

12. **Chain Processing (1 bi·∫øn):**
    - `files_for_chained_dubbing`

13. **Kh√°c (6 bi·∫øn internal):**
    - `subtitle_textbox_placeholder`, `min_duration_per_segment_ms`
    - `translate_batch_first_api_error_msg_shown`
    - `translate_batch_accumulated_api_error_details`
    - `manual_sub_then_dub_active`, `current_manual_merge_srt_path`
    - `continue_merge_event`, `system_fonts_cache`, `fonts_are_loading`

---

### B∆∞·ªõc 2.2: Di chuy·ªÉn H√ÄM Whisper (7 h√†m) ‚úÖ

**T·ªïng s·ªë:** ~291 d√≤ng code

1. `run_whisper_engine()` - Main Whisper transcription function
2. `_on_toggle_optimize_whisper_tts_voice()` - Toggle optimize TTS voice
3. `_determine_target_device()` - Device selection for Whisper
4. `load_whisper_model_if_needed()` - Load model if needed
5. `_load_whisper_model_thread()` - Thread worker for loading model
6. `_update_loaded_model()` - Update UI after model loaded
7. `_reset_model_loading_ui()` - Reset UI after loading complete

**Ph∆∞∆°ng ph√°p:** Manual copy theo s·ªë d√≤ng ch√≠nh x√°c t·ª´ `Piu.py`

---

### B∆∞·ªõc 2.3-2.6: Di chuy·ªÉn H√ÄM Logic (24 h√†m) ‚úÖ

**T·ªïng s·ªë:** ~1,880 d√≤ng code

#### Phase 2.3: GPT/Gemini Functions (14 h√†m)

**Gemini Functions (8 h√†m):**
1. `_trigger_gemini_script_processing_with_chain()` - Chain trigger
2. `_execute_gemini_script_editing_thread_for_chain()` - Chain worker
3. `_handle_gemini_script_editing_result_for_chain()` - Chain handler
4. `_execute_gemini_scene_division_thread()` - Scene division worker
5. `_handle_gemini_scene_division_result()` - Scene division handler
6. `_trigger_gemini_script_processing()` - Single trigger
7. `_execute_gemini_script_editing_thread()` - Single worker
8. `_handle_gemini_script_editing_result()` - Single handler

**GPT Functions (6 h√†m):**
9. `_trigger_gpt_script_processing_from_popup()` - Trigger from popup
10. `_execute_gpt_script_editing_thread()` - Worker thread
11. `_execute_gpt_scene_division_thread()` - Scene division worker
12. `_execute_gpt_single_summary_prompt_thread()` - Summary worker
13. `_handle_gpt_scene_division_result()` - Scene division handler
14. `_handle_gpt_script_editing_result()` - Script handler

#### Phase 2.4: Translation Functions (3 h√†m)

1. `translate_subtitle_file()` - Main wrapper for translation
2. `translate_google_cloud()` - Google Cloud Translate API
3. `translate_openai()` - OpenAI ChatGPT Translation API

#### Phase 2.5: Merge/Burn Functions (2 h√†m)

1. `burn_sub_to_video()` - Hardcode subtitles into video
2. `merge_sub_as_soft_sub()` - Softcode subtitles into video container

#### Phase 2.6: Edit & Manual Merge Functions (5 h√†m)

1. `_on_toggle_manual_merge_mode()` - Toggle manual merge mode
2. `load_old_sub_file()` - Load subtitle file for editing
3. `save_edited_sub()` - Save edited subtitle
4. `enable_sub_editing()` - Enable subtitle editing
5. `_execute_manual_merge_threaded()` - Manual merge worker thread

**Ph∆∞∆°ng ph√°p:** Manual copy - Ng∆∞·ªùi d√πng copy t·∫•t c·∫£ 24 h√†m theo y√™u c·∫ßu, sau ƒë√≥ t·ª± ƒë·ªông s·ª≠a references

---

### B∆∞·ªõc 2.7: S·ª≠a l·ªói Tham chi·∫øu ‚úÖ

#### Th√™m imports:
```python
import re, json, uuid, sys, subprocess
from datetime import datetime
from pathlib import Path
import pysubs2

from utils.helpers import (safe_int, create_safe_filename, parse_color_string_to_tuple,
                          play_sound_async, PLAYSOUND_AVAILABLE)
from utils.srt_utils import format_srt_data_to_string, extract_dialogue_from_srt_string
from utils.ffmpeg_utils import find_ffprobe
from services.ffmpeg_service import run_ffmpeg_command as ffmpeg_run_command
```

#### S·ª≠a tham chi·∫øu state variables:
- `self.ai_service` ‚Üí `self.master_app.ai_service`
- `self.stop_event` ‚Üí `self.master_app.stop_event`
- `self._track_api_call()` ‚Üí `self.master_app._track_api_call()`
- `self.after()` ‚Üí `self.master_app.after()`
- `self.start_time` ‚Üí `self.master_app.start_time`
- `self.cfg` ‚Üí `self.master_app.cfg`
- `self.gemini_key_var`, `self.openai_key_var` ‚Üí `self.master_app.xxx_var`
- `self.gemini_model_for_script_editing_var` ‚Üí `self.master_app.xxx_var`

#### S·ª≠a tham chi·∫øu UI methods:
- `self.update_status()` ‚Üí `self.master_app.update_status()`
- `self.update_time_realtime()` ‚Üí `self.master_app.update_time_realtime()`
- `self.update_queue_display()` ‚Üí `self.master_app.update_queue_display()`
- `self._set_subtitle_tab_ui_state()` ‚Üí `self.master_app._set_subtitle_tab_ui_state()`
- `self._check_completion_and_shutdown()` ‚Üí `self.master_app._check_completion_and_shutdown()`
- `self._is_app_fully_activated()` ‚Üí `self.master_app._is_app_fully_activated()`

#### S·ª≠a tham chi·∫øu ƒë·∫øn resources:
- `self.save_current_config()` ‚Üí `self.master_app.save_current_config()`
- `parent=self` ‚Üí `parent=self.master_app` trong messagebox calls

**K·∫øt qu·∫£:** 0 linter errors sau khi s·ª≠a xong

---

### B∆∞·ªõc 2.8: Di chuy·ªÉn Logic L∆∞u Config ‚úÖ

#### T·∫°o `SubtitleTab.save_config()`:

L∆∞u **39 c·∫•u h√¨nh** t·ª´ SubtitleTab v√†o `self.master_app.cfg`:

```python
def save_config(self):
    """L∆∞u c·∫•u h√¨nh Subtitle Tab v√†o master_app.cfg"""
    # Language & Options (9)
    # Pacing (5)
    # Style (13)
    # FFmpeg (3)
    # Block Merging (3)
    # Pause for Edit (1)
    # Manual Merge (1)
    # Others (4)
    # Output & Model (3)
```

#### C·∫≠p nh·∫≠t `Piu.save_current_config()`:

**Tr∆∞·ªõc ƒë√¢y:** L∆∞u tr·ª±c ti·∫øp ~40 d√≤ng code Subtitle config

**Sau khi refactor:**
```python
# Thu th·∫≠p C·∫•u h√¨nh Subtitle
# C√°c bi·∫øn Subtitle ƒë√£ ƒë∆∞·ª£c di chuy·ªÉn sang SubtitleTab, g·ªçi save_config() c·ªßa n√≥
if hasattr(self, 'subtitle_view_frame') and hasattr(self.subtitle_view_frame, 'save_config'):
    self.subtitle_view_frame.save_config()
```

**Gi·∫£m code:** T·ª´ ~40 d√≤ng ‚Üí 3 d√≤ng

---

## üéØ Impact

### File Size Changes:
- **subtitle_tab.py:** 798 d√≤ng ‚Üí 3,391 d√≤ng (+2,593 d√≤ng)
- **Piu.py:** Gi·∫£m ~2,234 d√≤ng logic Subtitle
- **Net effect:** Logic ƒë∆∞·ª£c t·ªï ch·ª©c t·ªët h∆°n, d·ªÖ maintain

### Code Organization:
- ‚úÖ 31 h√†m logic ƒë∆∞·ª£c t·∫≠p trung trong `SubtitleTab`
- ‚úÖ 60+ bi·∫øn state ƒë∆∞·ª£c qu·∫£n l√Ω trong m·ªôt class
- ‚úÖ `save_config()` pattern nh·∫•t qu√°n v·ªõi c√°c tab kh√°c
- ‚úÖ D·ªÖ d√†ng test v√† maintain h∆°n
- ‚úÖ Alias t∆∞∆°ng th√≠ch: `manual_merge_mode_var`, `pause_for_edit_var`, `continue_merge_event`, `manual_sub_queue`

### Testing Status:
- ‚úÖ **ƒê√£ test** - App ch·∫°y th√†nh c√¥ng, kh√¥ng c√≥ l·ªói
- ‚úÖ **Import th√†nh c√¥ng** - SubtitleTab import kh√¥ng c√≥ l·ªói
- ‚úÖ **UI hi·ªÉn th·ªã ƒë√∫ng** - T·∫•t c·∫£ widgets ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
- ‚è≥ **Ch·ª©c nƒÉng:** C·∫ßn test c√°c h√†m GPT/Gemini/Translation/Merge/Burn/Edit khi c√≥ th·ªùi gian

---

## üöÄ Next Steps

### Phase 3: Refactor Dubbing Tab
- ∆Øu ti√™n ti·∫øp theo
- ∆Ø·ªõc t√≠nh: 3-4 gi·ªù
- R·ªßi ro: Th·∫•p - logic t∆∞∆°ng ƒë·ªëi ƒë·ªôc l·∫≠p

### Phase 5: D·ªçn d·∫πp Piu.py
- Sau khi t·∫•t c·∫£ tabs ƒë√£ refactor
- X√≥a bi·∫øn ƒë√£ di chuy·ªÉn kh·ªèi `Piu.__init__`
- T·ªëi ∆∞u `save_current_config()` 
- M·ª•c ti√™u: Gi·∫£m Piu.py t·ª´ 27K+ d√≤ng ‚Üí ~15-20K d√≤ng

---

## üìù Notes

- **Ph∆∞∆°ng ph√°p:** Manual copy + auto fix references (theo y√™u c·∫ßu ng∆∞·ªùi d√πng)
- **Advantages:** 
  - Ng∆∞·ªùi d√πng c√≥ th·ªÉ review code tr∆∞·ªõc khi copy
  - Tr√°nh l·ªói copy sai t·ª´ tool
  - T√¥i ch·ªâ s·ª≠a references - ch√≠nh x√°c h∆°n
- **Disadvantages:**
  - M·∫•t th·ªùi gian h∆°n so v·ªõi auto-migration
  - Nhi·ªÅu b∆∞·ªõc h∆°n
- **Trade-off:** Ch·∫•t l∆∞·ª£ng > T·ªëc ƒë·ªô

